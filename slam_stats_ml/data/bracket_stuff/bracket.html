<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Slam Stats</title>
    <style>
      /* Add your CSS styling here */
      /* For example: */
      text {
        font-family: Arial, sans-serif;
        font-size: 12px;
        fill: #333;
      }

      .setlected {
        fill: "blue";
      }
    </style>
  </head>
  <body>
    <div id="bracket"></div>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
      // set the dimensions and margins of the graph
      var margin = { top: 10, right: 30, bottom: 30, left: 60 },
        width = 3000 - margin.left - margin.right,
        height = 1500 - margin.top - margin.bottom;

      console.log("Hello");

      d3.csv("2010-2011.csv").then(function (data) {
        console.log("hello")
        drawMatchups(data);
      });

      console.log("Hello")

      function drawMatchups(data) {
        var boxHeight = 20;
        var boxWidth = 100;

        console.log(data);

        var svg = d3
          .select("#bracket")
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom);

        var matchupGroups = svg
          .selectAll("g")
          .data(data)
          .enter()
          .append("g")
          .attr("id", function (d, i) {
            return "matchup-" + d.matchup_id + "-" + d.team_id;
          })
          .attr("selected", "false")
          .attr("filled", function (d, i) {
            return d.team == "" ? "false" : "true";
          })
          .attr("transform", function (d, i) {
            return drawMatchup(i);
          })
          .on("click", function (e, d) {
            var matchup = d3.select(this).attr("id");
            var matchupID = matchup.split("-")[1];
            var teamID = matchup.split("-")[2];

            var currentMatchup = d3.select(this);
            var otherMatchup = d3.select("#matchup-" + matchupID + "-" + (teamID == 1 ? 2 : 1));

            if (currentMatchup.attr("filled") === "true") {
              // If current cell is filled
              if (currentMatchup.attr("selected") === "true") {
                // If current cell is selected
                clearCells(currentMatchup, data); // Unselect cell and all following cells
              } else {
                // If current cell is not selected
                currentMatchup.select("path").style("fill", "yellow");

                if (d.next !== "") {
                  // If current cell has a next game

                  if (otherMatchup.attr("selected") === "true") {
                    otherMatchup.attr("selected", "false");
                    clearCells(otherMatchup, data);
                  }

                  var nextMatchupID = d.next.split("-")[0];
                  var nextTeamID = d.next.split("-")[1];
                  var nextMatchup = d3.select("#matchup-" + nextMatchupID + "-" + nextTeamID);
                  var index = data.findIndex(
                    (dictionary) => dictionary["matchup_id"] === nextMatchupID && dictionary["team_id"] === nextTeamID
                  );

                  // Fill in next matchup with selected team
                  nextMatchup.select("text").text(d.team);
                  nextMatchup.attr("filled", "true");
                  data[index].team = d.team;
                  data[index].seed = d.seed;
                } else {
                  // Handle championship game selection
                }
              }
              currentMatchup.attr("selected", currentMatchup.attr("selected") === "true" ? "false" : "true");
            }
            // console.clear();
            // printData(24, 40);
            // printData(80, 88);
            // printData(108, 112);
            // printData(122, 124);
            // printData(129, 130);
            // printData(132, 133);
          });

        function printData(start, end) {
          console.log("======================");
          for (var i = start; i < end; i++) {
            // console.log(data[i])
            // console.log(d3.select("#matchup-" + data[i].matchup_id + "-" + data[i].team_id).attr("selected"))
          }
        }

        matchupGroups
          .append("path")
          .attr("d", function (d, i) {
            var top = i % 2 == 0 ? true : false;
            var bottom = i % 2 == 1 ? true : false;

            return rounded_rect(0, 0, boxWidth, boxHeight, 10, top, top, bottom, bottom);
          })
          .attr("fill", "white")
          .attr("stroke", "black");

        matchupGroups
          .append("text")
          .attr("x", 10)
          .attr("y", 15)
          .attr("unselectable", "on")
          .text(function (d) {
            return d.team;
          });
      }

      function clearCells(current, data) {
        var matchup = current.attr("id");
        var matchupID = matchup.split("-")[1];
        var teamID = matchup.split("-")[2];
        var index = data.findIndex(
          (dictionary) => dictionary["matchup_id"] === matchupID && dictionary["team_id"] === teamID
        );

        current.select("path").style("fill", "white");

        if (data[index].next !== "") {
          var nextMatchupID = data[index].next.split("-")[0];
          var nextTeamID = data[index].next.split("-")[1];
          var nextMatchup = d3.select("#matchup-" + nextMatchupID + "-" + nextTeamID);
          var nextIndex = data.findIndex(
            (dictionary) => dictionary["matchup_id"] === nextMatchupID && dictionary["team_id"] === nextTeamID
          );

          if (
            nextMatchup.attr("filled") === "true" &&
            current.select("text").text() === nextMatchup.select("text").text()
          ) {
            clearCells(nextMatchup, data);
            nextMatchup.select("text").text("");
            nextMatchup.attr("filled", "false");
            nextMatchup.attr("selected", "false");
            data[nextIndex].team = "";
            data[nextIndex].seed = "";
          }
        }
      }

      function drawMatchup(i) {
        if (i >= 0 && i <= 7) {
          return "translate(" + 620 + "," + (i % 2 == 1 ? i * 30 - 10 : i * 30) + ")";
        } else if (i >= 8 && i <= 71) {
          var y = i < 40 ? i - 8 : i - 40;
          return "translate(" + (i < 40 ? 20 : 1220) + "," + (y % 2 == 1 ? y * 30 - 10 : y * 30) + ")";
        } else if (i >= 72 && i <= 103) {
          var y = i < 88 ? i - 72 : i - 88;
          return "translate(" + (i < 88 ? 140 : 1100) + "," + ((y % 2 == 1 ? y * 60 - 40 : y * 60) + 30) + ")";
        } else if (i >= 104 && i <= 119) {
          var y = i < 112 ? i - 104 : i - 112;
          return "translate(" + (i < 112 ? 260 : 980) + "," + ((y % 2 == 1 ? y * 120 - 100 : y * 120) + 90) + ")";
        } else if (i >= 120 && i <= 127) {
          var y = i < 124 ? i - 120 : i - 124;
          return "translate(" + (i < 124 ? 380 : 860) + "," + ((y % 2 == 1 ? y * 240 - 220 : y * 240) + 210) + ")";
        } else if (i >= 128 && i <= 131) {
          var y = i < 130 ? i - 128 : i - 130;
          return "translate(" + (i < 130 ? 500 : 740) + "," + ((y % 2 == 1 ? y * 480 - 460 : y * 480) + 450) + ")";
        } else if (i >= 132) {
          var y = i - 132;
          return "translate(" + 620 + "," + ((i % 2 == 1 ? y * 480 - 460 : y * 480) + 450) + ")";
        }
      }

      // https://stackoverflow.com/a/13505624
      function rounded_rect(x, y, w, h, r, tl, tr, bl, br) {
        var retval;
        retval = "M" + (x + r) + "," + y;
        retval += "h" + (w - 2 * r);
        if (tr) {
          retval += "a" + r + "," + r + " 0 0 1 " + r + "," + r;
        } else {
          retval += "h" + r;
          retval += "v" + r;
        }
        retval += "v" + (h - 2 * r);
        if (br) {
          retval += "a" + r + "," + r + " 0 0 1 " + -r + "," + r;
        } else {
          retval += "v" + r;
          retval += "h" + -r;
        }
        retval += "h" + (2 * r - w);
        if (bl) {
          retval += "a" + r + "," + r + " 0 0 1 " + -r + "," + -r;
        } else {
          retval += "h" + -r;
          retval += "v" + -r;
        }
        retval += "v" + (2 * r - h);
        if (tl) {
          retval += "a" + r + "," + r + " 0 0 1 " + r + "," + -r;
        } else {
          retval += "v" + -r;
          retval += "h" + r;
        }
        retval += "z";
        return retval;
      }
    </script>

    <div>
      {% if result %}
      <p>{{ result }}</p>
      {% endif %}
    </div>
    <form action="/predict" method="post">
      <button type="submit">Predict</button>
    </form>
  </body>
</html>
